## 学習内容

このラボでは、Model Context Protocol（MCP）と[PostgreSQL Vector](https://github.com/pgvector/pgvector){:target="_blank"}拡張機能が有効になったPostgreSQLデータベースを使用して、Azure AI エージェントでセマンティック検索機能を有効にします。

## はじめに

このラボでは、Model Context Protocol（MCP）とPostgreSQLを使用してセマンティック検索でAzure AI エージェントをアップグレードします。製品名と説明は、OpenAI埋め込みモデル（text-embedding-3-small）でベクトルに変換され、データベースに保存されました。これにより、エージェントがユーザーの意図を理解し、より正確な応答を提供できるようになります。

## ラボ演習

前のラボでは、エージェントに売上データについて質問することができましたが、完全一致に限定されていました。このラボでは、Model Context Protocol（MCP）を使用してセマンティック検索を実装することで、エージェントの機能を拡張します。これにより、エージェントが完全一致しないクエリを理解して応答できるようになり、より複雑な質問でユーザーを支援する能力が向上します。

1. ブラウザーのWeb Chatタブに以下の質問を貼り付けます：

    ```text
    18アンペアのサーキットブレーカーは何を販売していますか？
    ```

    エージェントは次のようなメッセージで応答します：「在庫に特定の18アンペアサーキットブレーカーが見つかりませんでした。ただし、他のタイプのサーキットブレーカーが利用可能な場合があります。一般的なサーキットブレーカーやその他の関連製品を検索しますか？😊」

## エージェントアプリを停止

VS Codeから、<kbd>Shift + F5</kbd>を押してエージェントアプリを停止します。

## セマンティック検索の実装

このセクションでは、Model Context Protocol（MCP）を使用してセマンティック検索を実装し、エージェントの機能を強化します。

1. <kbd>F1</kbd>を押してVS Code コマンドパレットを**開きます**。
2. **Open File** と入力し、**File: Open File...** を選択します。
3. ファイルピッカーに以下のパスを**貼り付け**、<kbd>Enter</kbd>を押します：

    ```text
    /workspace/src/python/mcp_server/sales_analysis/sales_analysis.py
    ```

4. 約100行目まで下にスクロールして、`semantic_search_products` メソッドを探します。このメソッドは、売上データでセマンティック検索を実行する責任があります。**@mcp.tool()** デコレーターがコメントアウトされていることがわかります。このデコレーターは、メソッドをMCPツールとして登録し、エージェントから呼び出せるようにするために使用されます。

5. 行の先頭の `#` を削除して、`@mcp.tool()` デコレーターのコメントアウトを解除します。これによりセマンティック検索ツールが有効になります。

    ```python
    # @mcp.tool()
    async def semantic_search_products(
        ctx: Context,
        query_description: Annotated[str, Field(
        ...
    ```

6. 次に、エージェント指示でセマンティック検索ツールを使用できるようにする必要があります。`app.py` ファイルに戻ります。
7. 約30行目まで下にスクロールして、`# INSTRUCTIONS_FILE = "instructions/mcp_server_tools_with_semantic_search.txt"` の行を見つけます。
8. 先頭の `#` を削除して行のコメントアウトを解除します。これによりエージェントがセマンティック検索ツールを使用できるようになります。

    ```python
    INSTRUCTIONS_FILE = "instructions/mcp_server_tools_with_semantic_search.txt"
    ```

## エージェント指示を確認

1. <kbd>F1</kbd>を押してVS Code コマンドパレットを開きます。
2. **Open File** と入力し、**File: Open File...** を選択します。
3. ファイルピッカーに以下のパスを貼り付けて<kbd>Enter</kbd>を押します：

    ```text
    /workspace/src/shared/instructions/mcp_server_tools_with_semantic_search.txt
    ```

4. ファイルの指示を確認します。これらの指示は、売上データについての質問に答えるためにセマンティック検索ツールを使用するようにエージェントに指示します。

## セマンティック検索ツールでエージェントアプリを開始

1. <kbd>F5</kbd>を押してエージェントアプリを**開始**します。これにより、更新された指示とセマンティック検索ツールが有効になったエージェントが開始されます。
2. ブラウザーの**Web Chat**タブに戻ります。
3. チャットに以下の質問を入力します：

    ```text
    18アンペアのサーキットブレーカーは何を販売していますか？
    ```

    エージェントは今度は質問のセマンティックな意味を理解し、関連する売上データで適切に応答します。

    !!! info "注記"
        MCP セマンティック検索ツールは以下のように動作します：

        1. 質問は、製品説明と同じOpenAI埋め込みモデル（text-embedding-3-small）を使用してベクトルに変換されます。
        2. このベクトルは、PostgreSQLデータベースで類似する製品ベクトルを検索するために使用されます。
        3. エージェントは結果を受け取り、それらを使用して応答を生成します。

## エグゼクティブレポートの作成

このワークショップの最終プロンプトは以下の通りです：

```plaintext
これらのサーキットブレーカーについて、異なる店舗の売上実績に関するエグゼクティブレポートを作成してください。
```

## エージェントアプリを実行したままにする

次のラボでエージェントをより多くのツールと機能で拡張するために使用するので、エージェントアプリを実行したままにしてください。

*GitHub Copilot を使用して翻訳されました。*
