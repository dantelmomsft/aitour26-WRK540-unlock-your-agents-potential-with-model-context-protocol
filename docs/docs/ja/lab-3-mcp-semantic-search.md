## 学習内容

このラボでは、Model Context Protocol (MCP) と PostgreSQL データベースを使用して Azure AI Agent でセマンティック検索機能を有効にします。

## はじめに

このラボでは、Model Context Protocol (MCP) と PostgreSQL を使用してセマンティック検索で Azure AI Agent をアップグレードします。製品名と説明は OpenAI 埋め込みモデル（text-embedding-3-small）でベクトルに変換され、データベースに保存されています。これにより、エージェントはユーザーの意図を理解し、より正確な応答を提供できます。

## ラボ演習

前のラボでは、エージェントに売上データについて質問できましたが、完全一致に限定されていました。このラボでは、Model Context Protocol (MCP) を使用してセマンティック検索を実装することで、エージェントの機能を拡張します。これにより、エージェントは完全一致でないクエリを理解して応答でき、より複雑な質問でユーザーを支援する能力が向上します。

1. ブラウザの Web Chat タブに以下の質問を貼り付けてください：

    ```text
    18A ブレーカーで各店舗のパフォーマンスはどうでしたか？
    ```

    エージェントは次のように応答します：「記録に18Aブレーカーの売上データが見つかりませんでした。😱 ただし、探索したい類似製品のいくつかの提案があります。」これは、エージェントがキーワードによるクエリマッチングのみに依存し、質問のセマンティックな意味を理解していないためです。LLM は、既に持っている製品コンテキストから教育的な製品提案を行う場合があります。

## セマンティック検索を実装する

このセクションでは、Model Context Protocol (MCP) を使用してセマンティック検索を実装し、エージェントの機能を向上させます。

1. <kbd>F1</kbd> を押して VS Code コマンドパレットを**開きます**。
2. **Open File** と入力し、**File: Open File...** を選択します。
3. 次のパスをファイルピッカーに**貼り付け**、<kbd>Enter</kbd> を押します：

    ```text
    /workspace/src/python/mcp_server/sales_analysis/sales_analysis.py
    ```

4. 約100行目までスクロールし、`semantic_search_products` メソッドを探します。このメソッドは売上データのセマンティック検索を実行する責任があります。**@mcp.tool()** デコレータがコメントアウトされていることがわかります。このデコレータは、メソッドを MCP ツールとして登録し、エージェントによって呼び出されるようにするために使用されます。

5. 行の先頭の `#` を削除して `@mcp.tool()` デコレータのコメントアウトを解除します。これによりセマンティック検索ツールが有効になります。

    ```python
    # @mcp.tool()
    async def semantic_search_products(
        ctx: Context,
        query_description: Annotated[str, Field(
        ...
    ```

6. 次に、セマンティック検索ツールを使用するエージェント指示を有効にする必要があります。`app.py` ファイルに戻ります。
7. 約30行目までスクロールし、`# INSTRUCTIONS_FILE = "instructions/mcp_server_tools_with_semantic_search.txt"` の行を見つけます。
8. 行の先頭の `#` を削除してコメントアウトを解除します。これによりエージェントがセマンティック検索ツールを使用できるようになります。

    ```python
    INSTRUCTIONS_FILE = "instructions/mcp_server_tools_with_semantic_search.txt"
    ```

## エージェント指示を確認する

1. <kbd>F1</kbd> を押して VS Code コマンドパレットを開きます。
2. **Open File** と入力し、**File: Open File...** を選択します。
3. 次のパスをファイルピッカーに貼り付け、<kbd>Enter</kbd> を押します：

    ```text
    /workspace/src/shared/instructions/mcp_server_tools_with_semantic_search.txt
    ```

4. ファイル内の指示を確認します。これらの指示は、エージェントにセマンティック検索ツールを使用して売上データに関する質問に答えるよう指示しています。

## セマンティック検索ツール付きエージェントアプリを開始する

1. <kbd>Shift + F5</kbd> を押して現在のエージェントアプリを**停止**します。
2. <kbd>F5</kbd> を押してエージェントアプリを**再起動**します。これにより、更新された指示とセマンティック検索ツールが有効になったエージェントが開始されます。
3. ブラウザの **Web Chat** タブに戻ります。
4. チャットに以下の質問を入力します：

    ```text
    18A ブレーカーで各店舗のパフォーマンスはどうでしたか？
    ```

    エージェントは質問のセマンティックな意味を理解し、関連する売上データで適切に応答するようになりました。

    !!! info "注意"
        MCP セマンティック検索ツールは次のように動作します：

        1. 質問は、製品説明と同じ OpenAI 埋め込みモデル（text-embedding-3-small）を使用してベクトルに変換されます。
        2. このベクトルは、PostgreSQL データベース内の類似製品ベクトルを検索するために使用されます。
        3. エージェントは結果を受け取り、それらを使用して応答を生成します。

*Translated using GitHub Copilot and GPT-4o.*
