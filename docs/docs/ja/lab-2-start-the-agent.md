## 学習内容

このラボでは、自然言語を使用して売上データを分析し、チャートを作成するためにコードインタープリターを有効にします。

## はじめに

このラボでは、Azure AI エージェントを2つのツールで拡張します：

- **コードインタープリター:** エージェントがデータ分析と可視化のためにPythonコードを生成および実行できるようにします。
- **MCP サーバーツール:** エージェントがMCPツールを使用して外部データソース（この場合はPostgreSQLデータベースのデータ）にアクセスできるようにします。

## ラボ演習

### コードインタープリターを有効にする

このラボでは、Zavaのリテールセールスデータを分析するためにLLMによって生成されたPythonコードを実行するコードインタープリターを有効にします。

=== "Python"

    1. `app.py` を**開きます**。
    2. `AgentManager` クラスの `_setup_agent_tools` メソッドで、エージェントのツールセットにコードインタープリターツールを追加する行の**コメントアウトを解除**します。この行は現在、先頭に `#` でコメントアウトされています：

        ```python
        # code_interpreter = CodeInterpreterTool()
        # self.toolset.add(code_interpreter)
        ```

    3. `app.py` ファイルのコードを**確認**します。`AgentManager` クラスの `_setup_agent_tools` メソッドで、コードインタープリターとMCPサーバーツールがエージェントのツールセットに追加されることがわかります。

        ```python

        コメントアウトを解除した後、コードは次のようになります：

        ```python
        class AgentManager:
            """Azure AI エージェントのライフサイクルと依存関係を管理します。"""

            async def _setup_agent_tools(self) -> None:
                """MCP ツールとコードインタープリターを設定します。"""

                # コードインタープリターツールを有効にする
                code_interpreter = CodeInterpreterTool()
                self.toolset.add(code_interpreter)

                print("エージェントツールを設定中...")
                ...
        ```

=== "C#"

    TBD

## エージェントアプリの開始

1. 以下のテキストをクリップボードにコピーします：

    ```text
    Debug: Select and Start Debugging
    ```

2. <kbd>F1</kbd> を押して VS Code コマンドパレットを開きます。
3. テキストをコマンドパレットに貼り付け、**Debug: Select and Start Debugging** を選択します。
4. リストから **🔁🤖Debug Compound: Agent and MCP (stdio)** を選択します。これによりエージェントアプリとウェブチャットクライアントが開始されます。

## エージェント ウェブチャットクライアントを開く

1. 以下のテキストをクリップボードにコピーします：

    ```text
    Open Port in Browser
    ```

2. <kbd>F1</kbd> を押して VS Code コマンドパレットを開きます。
3. テキストをコマンドパレットに貼り付け、**Open Port in Browser** を選択します。
4. リストから **8005** を選択します。これによりブラウザーでエージェント ウェブチャットクライアントが開きます。

### エージェントとの会話開始

ウェブチャットクライアントから、エージェントとの会話を開始できます。エージェントは、Zavaの売上データに関する質問に答え、コードインタープリターを使用して可視化を生成するように設計されています。

1. 製品売上分析。以下の質問をコピーしてチャットに貼り付けます：

    ```text
    先四半期の店舗別売上高上位10製品を表示してください
    ```

    しばらくすると、エージェントは各店舗の売上高上位10製品を示すテーブルで応答します。

    !!! info
        エージェントはLLMを使用して3つのMCPサーバーツールを呼び出し、データを取得してテーブルに表示します：

           1. **get_current_utc_date()**: 現在の日時を取得し、エージェントが現在の日付に対して相対的に先四半期を決定できるようにします。
           2. **get_multiple_table_schemas()**: 有効なSQLを生成するためにLLMが必要とするデータベース内のテーブルのスキーマを取得します。
           3. **execute_sales_query**: PostgreSQLデータベースから先四半期の売上高上位10製品を取得するSQLクエリを実行します。

2. 円グラフを生成します。以下の質問をコピーしてチャットに貼り付けます：

    ```text
    今財務年度の店舗別売上を円グラフで表示してください
    ```

    エージェントは、現在の財務年度の店舗別売上分布を示す円グラフで応答します。

    !!! info
        これは魔法のように感じるかもしれませんが、すべてを機能させるために舞台裏で何が起こっているのでしょうか？

        Foundry エージェントサービスは以下の手順を調整します：

        1. 前の質問と同様に、エージェントはクエリに必要なテーブルスキーマがあるかどうかを判断します。ない場合は、**get_multiple_table_schemas()** ツールを使用して現在の日付とデータベーススキーマを取得します。
        2. 次に、エージェントは **execute_sales_query** ツールを使用して売上を取得します。
        3. 返されたデータを使用して、LLMは円グラフを作成するPythonコードを書きます。
        4. 最後に、コードインタープリターがPythonコードを実行してチャートを生成します。

3. Zavaの売上データについて質問を続けて、コードインタープリターの動作を確認してください。試してみたいフォローアップ質問をいくつか示します：

    - ```売上を促進する製品またはカテゴリを特定してください。棒グラフで表示してください。```
    - ```ショック イベント（例：1つの地域で売上が20%減少）がグローバルな売上分布に与える影響は何でしょうか？グループ化棒グラフで表示してください。```
        - フォローアップで ```ショック イベントが50%だった場合はどうでしょうか？```
    - ```平均を上回るまたは下回る売上がある地域はどこですか？平均からの偏差を示す棒グラフで表示してください。```
    - ```平均を上回るまたは下回る割引がある地域はどこですか？平均からの偏差を示す棒グラフで表示してください。```
    - ```モンテカルロ シミュレーションを使用して地域別の将来の売上をシミュレートし、信頼区間を推定してください。鮮やかな色を使用して信頼帯付きの線で表示してください。```

<!-- ## エージェントアプリを停止

1. VS Code エディターに戻ります。
1. <kbd>Shift + F5</kbd> を押してエージェントアプリを停止します。 -->

## エージェントアプリを実行したままにする

次のラボでエージェントをより多くのツールと機能で拡張するために使用するので、エージェントアプリを実行したままにしてください。

*GitHub Copilot を使用して翻訳されました。*
